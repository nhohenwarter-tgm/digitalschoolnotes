%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document Class
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[12pt,a4paper,oneside,ngerman]{scrartcl}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[ngerman]{babel}
\usepackage[utf8]{inputenc}
\usepackage[nottoc,numbib]{tocbibind}
\usepackage[T1]{fontenc}
\usepackage{fancyhdr}
\usepackage{booktabs}
\usepackage[page]{totalcount}
\usepackage{tikz}
\usepackage{color, colortbl}
\usepackage{url}
\usepackage{tabularx}
\renewcommand{\familydefault}{\sfdefault}
\usepackage{lmodern}
\usepackage{geometry}
\usepackage{ragged2e}
\usepackage{listings}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Colors
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{g1}{RGB}{46,184,46}
\definecolor{g2}{RGB}{37,147,37}
\definecolor{g3}{RGB}{29,114,29}
\definecolor{g4}{RGB}{20,82,20}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Page Margin
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\geometry{
  left=2.5cm,
  right=2.5cm,
  top=2.5cm,
  bottom=2.5cm
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Own Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\raggedright
\newcommand{\tabhvent}[1]{\noindent\parbox[c]{\hsize}{#1}}
\newcolumntype{b}{X}
\newcolumntype{s}{>{\hsize=.5\hsize}X}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Code Lists
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstset{breaklines=true,
		frame=single,
		language=bash}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document Start
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title Page
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\thispagestyle{empty}
\vspace*{2cm}

%Rectangle
\begin{center}
\begin{Huge}
\begin{tikzpicture}
\draw[g1, line width=1mm, text=black, align=center] (0,5) rectangle (10,10) node[midway] {Serverdokumentation\\ Projekt: DigitalSchoolNotes};
\end{tikzpicture}
\end{Huge}
\end{center}
\vspace{8cm}

\textit{\textbf{Projektgruppe: Adler, Brinnich, Hohenwarter, Karic, Stedronsky}}
\vspace{10mm}

\textbf{{\color{g4}Version 1.2 \hfill 12.10.2015 \hfill Status: [RELEASE]}}
%Table
\begin{table}[h]
\renewcommand{\arraystretch}{2.0}
\centering
\begin{tabularx}{\textwidth}{|s|s|b|b|}
\hline
\rowcolor{g1} 
\tabhvent{}&\tabhvent{\textbf{Datum}} & \tabhvent{\textbf{Name}} & \tabhvent{\textbf{Unterschrift}} \\ \hline
\tabhvent{\textbf{Erstellt}} & \tabhvent{09.09.2015} & \tabhvent{Niklas Hohenwarter} &  \tabhvent{}            \\ \hline
\tabhvent{\textbf{Geprüft}} & \tabhvent{} & \tabhvent{} &  \tabhvent{}            \\ \hline
\tabhvent{\textbf{Freigegeben}} & \tabhvent{} & \tabhvent{} &  \tabhvent{}            \\ \hline
\specialrule{0.07em}{0em}{0em}
\multicolumn{4}{|l|}{\textbf{Git-Pfad:} /doc/serverdokumentation \hfill \textbf{Dokument:} serverdoc.tex}                    \\ \hline
\end{tabularx}
\end{table}
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Header & Footer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\setlength\headheight{15pt}
\lhead{Serverdokumentation}
\rhead{Version 1.2}
\lfoot{Adler, Brinnich, Hohenwarter, Karic, Stedronsky}
\cfoot{}
\rfoot{Seite \thepage \hspace{1pt} von \totalpages}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Table of Contents
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents\thispagestyle{fancy}
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Changelog
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Changelog}

%Table
\begin{table}[h]
\renewcommand{\arraystretch}{2.0}
\centering
\begin{tabularx}{\textwidth}{|s|s|s|s|b|}
\hline
\rowcolor{g1} 

%Header
\tabhvent{\textbf{Version}} &\tabhvent{\textbf{Datum}} & \tabhvent{\textbf{Status}} & \tabhvent{\textbf{Bearbeiter}} & \tabhvent{\textbf{Kommentar}}  \\ \hline

%Lines
\tabhvent{\textbf{0.1}} & \tabhvent{09.09.2015} & \tabhvent{Erstellt} &  \tabhvent{Hohenwarter}    &  \tabhvent{Draft}         \\ \hline
\tabhvent{\textbf{0.2}} & \tabhvent{21.09.2015} & \tabhvent{Bearbeitet} &  \tabhvent{Hohenwarter}    &  \tabhvent{Alles verbessert}         \\ \hline
\tabhvent{\textbf{1.0}} & \tabhvent{28.09.2015} & \tabhvent{QA} &  \tabhvent{Stedronsky}    &  \tabhvent{Rechtschreibung}         \\ \hline
\tabhvent{\textbf{1.1}} & \tabhvent{07.10.2015} & \tabhvent{Bearbeitet} &  \tabhvent{Hohenwarter}    &  \tabhvent{Django Ports}         \\ \hline
\tabhvent{\textbf{1.1}} & \tabhvent{12.10.2015} & \tabhvent{Bearbeitet} &  \tabhvent{Hohenwarter}    &  \tabhvent{Deployment}         \\ \hline
\tabhvent{\textbf{1.2}} & \tabhvent{14.10.2015} & \tabhvent{QA} &  \tabhvent{Stedronsky}    &  \tabhvent{Rechtschreibfehler}         \\ \hline
\tabhvent{\textbf{1.2}} & \tabhvent{14.10.2015} & \tabhvent{Bearbeitet} &  \tabhvent{Hohenwarter}    &  \tabhvent{uWsgi}         \\ \hline
\end{tabularx}
\end{table}
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Content Start
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\justify
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Übersicht
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Hosting}
Unser Projektserver ist beim in Deutschland ansässigen Unternehmen Netcup\cite{NETCUP:1} gehostet. Hier haben wir den Root-Server M angemietet(2 Cores Intel®Xeon® E5-26xxV3
(min. 2,3 GHz je Kern), 6 GB DDR4(ECC),120GB SSD, 1 GBit/s)\cite{NETCUP:2} mit dem OS Debian 8 und mit der Kernel Version 3.16.0-4-amd64. Dieser ist unter der IP Adresse \textbf{37.120.161.195} erreichbar.\\

Auf dem Server ist die Domain digitalschoolnotes.com geschaltet. Diese ist ebenfalls bei netcup gemietet.\\

Folgende Subdomains existieren:

\begin{itemize}
\item time.digitalschoolnotes.com \hfill Zeitaufzeichnung
\item git.digitalschoolnotes.com \hfill Repository
\item ontime.digitalschoolnotes.com \hfill Scrum Tool
\end{itemize}

\section{User}
Jedes Projektteam Mitglied hat einen eigenen Unix Account auf dem Projektserver. Der Vorname der Person ist der Benutzername. Das Benutzerpasswort ist von jedem Teammitglied selbst gewählt. Alle Teammitglieder haben sudo rechte. Verantwortlich für die Serververwaltung ist Niklas Hohenwarter. Bei Problemen mit der Anmeldung oder anderem sind diese ihm bekannt zu geben.

\section{Mailsystem}
Das Projektteam hat einen Email-Verteiler mit der Adresse info@digitalschoolnotes.com. Jedes Teammitglied hat eine E-Mail Adresse nach dem Schema des TGMs. Der Scrummaster ist unter scrummaster@digitalschoolnotes.com erreichbar.

\section{SSH}
Aus Sicherheitsgründen wurde die Anmeldung mit Passwort verboten und es können hierfür nurnoch SSH Keys verwendet werden.
\newpage

\section{Firewall}
Es werden prinzipiell alle eingehenden Ports geschlossen. Ausnahmen sind hier aufzulisten. Bei Änderungswünschen ist der Serveradministrator zu kontaktieren.\\

Ausnahmen:
\begin{itemize}
\item 22	SSH
\item 53	DNS
\item 80	HTTP
\item 443	HTTPS
\item 5001-5005 Django Development
\end{itemize}

\subsection{Konfiguration}
Die Firewall wird mittels folgenden Befehlen aufgesetzt:
\begin{lstlisting}
# Flush the tables to apply changes
iptables -F

# Default policy to drop 'everything' but our output to internet
iptables -P FORWARD DROP
iptables -P INPUT   DROP
iptables -P OUTPUT  ACCEPT

# Allow established connections (the responses to our outgoing traffic)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow local programs that use loopback (Unix sockets)
iptables -A INPUT -s 127.0.0.0/8 -d 127.0.0.0/8 -i lo -j ACCEPT
iptables -A FORWARD -s 127.0.0.0/8 -d 127.0.0.0/8 -i lo -j ACCEPT

#Allowed Ports
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -m state --state NEW -j ACCEPT
iptables -A INPUT -p udp --dport 53 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 5001 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 5002 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 5003 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 5004 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 5005 -m state --state NEW -j ACCEPT
\end{lstlisting}


Die Firewallrules werden beim Reboot automatisch wiederhergestellt. Dies geschieht durch das Paket \textbf{\textit{iptables-persistent}}. Konfiguration\cite{HOWTO:2}:

\begin{lstlisting}
# Install
sudo apt-get install iptables-persistent

# Save Rules
iptables-save > /etc/iptables/rules.v4
\end{lstlisting}

\section{Bruteforce Prevention}
Um den SSH Zugang gegen Brute Force Attacken abzusichern wurde fail2ban installiert. Dieses Paket versucht Bruteforce Attacken zu verhindern. \cite{HOWTO:1} \\

\subsection{Konfiguration}
Das Paket wurde mittels \textbf{\textit{sudo apt-get install fail2ban}} installiert. Die Standardkonfiguration wurde angepasst, um all unsere Services zu schützen.

\section{Webserver}
Als Webserver wird nginx verwendet. Aktuell existieren auf dem Server nur Weiterleitungen zu unserem Github Repository, Taiga, der Zeitaufzeichnung und dem CI Tool (Subdomains, siehe oben).

\subsection{Konfiguration}
Die Konfiguration ist in \textbf{\textit{/etc/nginc/sites-available/redirects}} zu finden. Sie enthält folgendes:

\begin{lstlisting}
server {
	listen 80; #Port
	server_name git.digitalschoolnotes.com; # Subdomain

    	location / {
	   rewrite ^ https://github.com/nhohenwarter-tgm/digitalschoolnotes permanent; # zieladresse der Weiterleitung
    	}
}

server {
        listen 80;
        server_name ontime.digitalschoolnotes.com;

        location / {
           rewrite ^ tgm.axosoft.com permanent;
        }
}


server {
        listen 80;
        server_name time.digitalschoolnotes.com;

        location / {
           rewrite ^ https://goo.gl/IWrE2j permanent;
        }
}

\end{lstlisting}

Um die Weiterleitung zu aktivieren muss ein Link nach \textbf{\textit{/etc/nginx/sites-enabled}} gesetzt werden. Dies geht mit dem Befehl \textbf{\textit{ln -s /etc/nginx/sites-available/redirects /etc/nginx/sites-enabled/redirects}}. Dannach muss der Nginx Service neu gestartet werden. Diese geschieht mit dem Befehl \textbf{\textit{service nginx reload}}.

\section{Deployment}
\subsection{SSL}
Um die Daten verschlüsselt übertragen zu können wird ein SSL Zertifikat benötigt. Dieses kaufen wir bei unserem Hoster. Wir haben uns für das Thwawte SSL123 Zertifikat\cite{CERT:1} für 1 Jahr entschieden. Bei dem Kauf des Zertifikates muss auf dem Server zuerst eine Zertifikatsanfrage erstellt werden(CSR).\\

Dies geschieht wie folgt\cite{CERT:2}:
\begin{lstlisting}
openssl req -new -newkey rsa:2048 -nodes -sha256 -keyout dsn.key -out dsn.csr
Generating a 2048 bit RSA private key
.................................................................+++
..........+++
writing new private key to 'dsn.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:AT
State or Province Name (full name) [Some-State]:Wien
Locality Name (eg, city) []:Wien
Organization Name (eg, company) [Internet Widgits Pty Ltd]:DigitalSchoolNotes
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:digitalschoolnotes.com
Email Address []:root@digitalschoolnotes.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
\end{lstlisting}
Nach dem beantworten der Fragen wird das CSR generiert. Dieses muss dann beim Kauf angegeben werden. Dannach muss das Zertifikat bezahlt werden. Nun bekommt man das Zertifikat per Email.

Nun muss das Zertifikat auf Nginx eingerichtet werden\cite{CERT:3}:
Man benötigt das Zertifikat, das öffentliche Zertifikat von Thawte und den Private Key.
Diese müssen nun zusammengefügt werden.
\begin{lstlisting}
cat digitalschoonotes.com.crt intermediate.crt > digitalschoolnotes.com.chain.crt
\end{lstlisting}
Nun muss Nginx konfiguriert werden.
\begin{lstlisting}
#/etc/nginx/sites-available/default
server {
        listen 80;
        listen 443 ssl;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name digitalschoolnotes.com;
        ssl_certificate /home/niklas/ssl/digitalschoolnotes.com.chained.crt;
        ssl_certificate_key /home/niklas/ssl/digitalschoolnotes.com.key;

        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;
        ssl_verify_depth 3;

        if ($ssl_protocol = "") {
            rewrite ^   https://$server_name$request_uri? permanent;
        }

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
}
\end{lstlisting}
Es werden nun alle HTTP Anfragen nach HTTPS umgeleitet.

\subsection{Gunicorn}
Wir haben uns dazu entschieden im Produktiveinsatz Django mit gunicorn zu deployen. Nginx beantwortet alle statischen Anfragen. Fall etwas von Django abgefragt werden muss, leitet Nginx die Anfrage an Djano weiter. Die Konfiguration läuft wie folgt ab\cite{GUNICORN:1}:\\
Als erstes muss gunicorn installiert werden:
\begin{lstlisting}
sudo pip3 install gunicorn
\end{lstlisting}
Nun verwenden wir Supervisor um gunicorn\cite{GUNICORN:2} auszuführen. Supervisor kann das ganze dann über einen Kommander starten und stoppen. Zunächst erstellen wir ein Konfigurationsfile:
\begin{lstlisting}
sudo vim /etc/supervisor/conf.d/dsnselina.conf

[program:dsnselina]
directory=/home/selina/dsn
user=selina
command=gunicorn --bind 0.0.0.0:8001 dsn.wsgi:application
autostart=true
autorestart=true
\end{lstlisting}

Nun können wir über den Kommander das Programm dsnselina starten oder beenden.
\begin{lstlisting}
sudo supervisorctl

start dsnselina #Starten
stop dsnselina #Stoppen
status #Status aller Programme
\end{lstlisting}

Zuletzt fehlt noch die Konfiguration von Nginx. Hierzu legen wir ein neues Konfigurationsfile an:
\begin{lstlisting}
cd /etc/nginx/sites-available
cp default selina
vim selina

server {
        listen 5001;

        root /home/selina/dsn/dsn/static;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name digitalschoolnotes.com;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
        
        location /nojs {
        }

        location /api/ {
                proxy_pass  http://127.0.0.1:8001;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
}

ln -s selina ../sites-enabled/selina

\end{lstlisting}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Bibliography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliography{serverdoc} 
\bibliographystyle{ieeetr}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Content End
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document End
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
